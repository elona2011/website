(function () {
    let treeData = {
        "name": "XXX总",
        "children": [{
            "name": "a事业",
            "children": [{
                "name": "IAA",
                "children": null,
                "orgCode": "2901"
            }, {
                "name": "中间",
                "children": null,
                "orgCode": "2902"
            }, {
                "name": "云商",
                "children": null,
                "orgCode": "2903"
            }, {
                "name": "内核",
                "children": null,
                "orgCode": "2904"
            }, {
                "name": "大数",
                "children": null,
                "orgCode": "2905"
            }, {
                "name": "安全",
                "children": null,
                "orgCode": "2906"
            }, {
                "name": "据库",
                "children": null,
                "orgCode": "2907"
            }, {
                "name": "监控",
                "children": null,
                "orgCode": "2908"
            }, {
                "name": "自开",
                "children": null,
                "orgCode": "2909"
            }],
            "orgCode": "1319"
        }, {
            "name": "员工",
            "children": [{
                "name": "事办",
                "children": null,
                "orgCode": "2937"
            }, {
                "name": "共享",
                "children": null,
                "orgCode": "2938"
            }, {
                "name": "员工",
                "children": null,
                "orgCode": "2939"
            }, {
                "name": "工门",
                "children": null,
                "orgCode": "2940"
            }, {
                "name": "地产",
                "children": null,
                "orgCode": "2941"
            }, {
                "name": "经办",
                "children": null,
                "orgCode": "2942"
            }, {
                "name": "bbb",
                "children": null,
                "orgCode": "2943"
            }, {
                "name": "务支",
                "children": null,
                "orgCode": "2944"
            }, {
                "name": "务核",
                "children": null,
                "orgCode": "2945"
            }],
            "orgCode": "1320"
        }, {
            "name": "c",
            "children": [{
                "name": "会员",
                "children": null,
                "orgCode": "2991"
            }, {
                "name": "基础",
                "children": null,
                "orgCode": "2992"
            }, {
                "name": "广告",
                "children": null,
                "orgCode": "2993"
            }, {
                "name": "能测",
                "children": null,
                "orgCode": "2994"
            }, {
                "name": "经办",
                "children": null,
                "orgCode": "2995"
            }, {
                "name": "搜索",
                "children": null,
                "orgCode": "2996"
            }, {
                "name": "务端",
                "children": null,
                "orgCode": "2997"
            }, {
                "name": "心交",
                "children": null,
                "orgCode": "2998"
            }, {
                "name": "移动",
                "children": null,
                "orgCode": "2999"
            }, {
                "name": "营销",
                "children": null,
                "orgCode": "3000"
            }, {
                "name": "门店",
                "children": null,
                "orgCode": "3001"
            }, {
                "name": "项目",
                "children": null,
                "orgCode": "3002"
            }, {
                "name": "道及",
                "children": null,
                "orgCode": "3003"
            }],
            "orgCode": "1321"
        }, {
            "name": "b",
            "children": [{
                "name": "开发",
                "children": null,
                "orgCode": "2928"
            }, {
                "name": "监办",
                "children": null,
                "orgCode": "2929"
            }],
            "orgCode": "1322"
        }, {
            "name": "技术支撑",
            "children": [{
                "name": "云计",
                "children": null,
                "orgCode": "2957"
            }, {
                "name": "大数",
                "children": null,
                "orgCode": "2958"
            }, {
                "name": "营商",
                "children": null,
                "orgCode": "2959"
            }],
            "orgCode": "1323"
        }, {
            "name": "零售云",
            "children": [{
                "name": "分销",
                "children": null,
                "orgCode": "3051"
            }, {
                "name": "端开",
                "children": null,
                "orgCode": "3052"
            }, {
                "name": "据研",
                "children": null,
                "orgCode": "3053"
            }, {
                "name": "客服",
                "children": null,
                "orgCode": "3054"
            }, {
                "name": "宁小",
                "children": null,
                "orgCode": "3055"
            }],
            "orgCode": "1324"
        }, {
            "name": "ccc",
            "children": [{
                "name": "上海",
                "children": null,
                "orgCode": "3026"
            }, {
                "name": "众筹",
                "children": null,
                "orgCode": "3027"
            }, {
                "name": "保险",
                "children": null,
                "orgCode": "3028"
            }, {
                "name": "小微",
                "children": null,
                "orgCode": "3029"
            }, {
                "name": "总经",
                "children": null,
                "orgCode": "3030"
            }, {
                "name": "技术",
                "children": null,
                "orgCode": "3031"
            }, {
                "name": "支付",
                "children": null,
                "orgCode": "3032"
            }, {
                "name": "风控",
                "children": null,
                "orgCode": "3033"
            }, {
                "name": "测试",
                "children": null,
                "orgCode": "3034"
            }, {
                "name": "清结",
                "children": null,
                "orgCode": "3035"
            }, {
                "name": "理财",
                "children": null,
                "orgCode": "3036"
            }, {
                "name": "场景",
                "children": null,
                "orgCode": "3037"
            }, {
                "name": "移动",
                "children": null,
                "orgCode": "3038"
            }, {
                "name": "会员",
                "children": null,
                "orgCode": "3039"
            }, {
                "name": "核心",
                "children": null,
                "orgCode": "3040"
            }],
            "orgCode": "1327"
        }, {
            "name": "后台服务",
            "children": [{
                "name": "售后",
                "children": null,
                "orgCode": "2932"
            }, {
                "name": "物流",
                "children": null,
                "orgCode": "2933"
            }, {
                "name": "物流",
                "children": null,
                "orgCode": "2934"
            }, {
                "name": "运配",
                "children": null,
                "orgCode": "2935"
            }],
            "orgCode": "1328"
        }],
        "orgCode": "1000"
    }

    let width = 1000,
        height = 28,
        svg = d3.select('svg')
        .attr('width', width)
        .attr('height', height),
        g = svg.append('g')
        .attr('transform', 'translate(90,0)'),
        root,
        i = 0,
        duration = 750

    let treemap = d3.tree()
        .size([height, width])
    root = d3.hierarchy(treeData, d => d.children)
    root.x0 = height / 2
    root.y0 = 0

    // root.children.forEach(collapse);
    collapse(root)
    update(root);

    function collapse(d) {
        if (d.children) {
            d._children = d.children
            d._children.forEach(collapse)
            d.children = null
        }
    }

    function update(source) {
        var treeData = treemap(root);

        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);

        nodes.forEach(function (d) {
            d.y = d.depth * 180
        });

        var node = g.selectAll('g.node')
            .data(nodes, function (d) {
                return d.id || (d.id = ++i);
            });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function (d) {
                return "translate(" + source.y0 + "," + source.x0 + ")";
            })
            .on('click', click);

        nodeEnter.append('circle')
            .attr('class', 'node')
            .attr('r', 1e-6)
            .style("fill", function (d) {
                return d._children ? "lightsteelblue" : "#fff";
            });

        nodeEnter.append('text')
            .attr("dy", ".35em")
            .attr("x", function (d) {
                return d.children || d._children ? -13 : 13;
            })
            .attr("text-anchor", function (d) {
                return d.children || d._children ? "end" : "start";
            })
            .text(function (d) {
                return d.data.name;
            });

        var nodeUpdate = nodeEnter.merge(node);

        nodeUpdate.transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + d.y + "," + d.x + ")";
            });

        nodeUpdate.select('circle.node')
            .attr('r', 10)
            .style("fill", function (d) {
                return d._children ? "lightsteelblue" : "#fff";
            })
            .attr('cursor', 'pointer');


        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function (d) {
                return "translate(" + source.y + "," + source.x + ")";
            })
            .remove();

        nodeExit.select('circle')
            .attr('r', 1e-6);

        nodeExit.select('text')
            .style('fill-opacity', 1e-6);

        var link = g.selectAll('path.link')
            .data(links, function (d) {
                return d.id;
            });

        var linkEnter = link.enter().insert('path', "g")
            .attr("class", "link")
            .attr('d', function (d) {
                var o = {
                    x: source.x0,
                    y: source.y0
                }
                return diagonal(o, o)
            });

        var linkUpdate = linkEnter.merge(link);

        linkUpdate.transition()
            .duration(duration)
            .attr('d', function (d) {
                return diagonal(d, d.parent)
            });

        var linkExit = link.exit().transition()
            .duration(duration)
            .attr('d', function (d) {
                var o = {
                    x: source.x,
                    y: source.y
                }
                return diagonal(o, o)
            })
            .remove();

        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });

        function diagonal(s, d) {

            let path = `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`

            return path
        }

        let num = 0

        function click(d) {
            if (d.children) {
                //收起
                d._children = d.children;
                d.children = null;
                resizeSVG()
                update(d);
            } else {
                //展开
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                    resizeSVG()
                    update(d);
                } else {
                    //调接口
                    if (+d.data.orgNodeType === 0) {
                        HttpService.get('/organizationMgr/getChildOrgByParentCode?orgParentCode=' + d.data.orgCode).then(n => {
                            d.data.children = n.organizationNodeBOs
                            let newChild = d3.hierarchy(d.data, d => d.children)
                            d.children = newChild.children
                            newChild.children.forEach(n => {
                                n.parent = d
                                n.depth += d.depth
                            })
                            d.height = newChild.height
                            let dd = d
                            while (dd.parent) {
                                dd.parent.height += 1
                                dd = dd.parent
                            }
                            resizeSVG()
                            update(d)
                        })
                    }
                }
            }
        }

        function resizeSVG() {
            num = 0
            getChildrenNum(root)
            height = 28 * num
            if (height > svg.attr('height')) {
                svg.attr('height', height)
            } else
                setTimeout(function () {
                    svg.attr('height', height)
                }, 1000);
            treemap = d3.tree().size([height, width])
        }

        function getChildrenNum(d) {
            if (d.children) {
                d.children.forEach(getChildrenNum)
            } else {
                num++
            }
        }
    }
})();